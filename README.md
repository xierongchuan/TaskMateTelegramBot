# TaskMate Telegram Bot

Telegram-клиент для системы управления задачами TaskMate. Позволяет сотрудникам автосалонов получать, подтверждать и выполнять задачи через Telegram.

## Стек

- **Python 3.12** + **aiogram 3.17** — асинхронный Telegram Bot Framework
- **httpx** — HTTP-клиент для взаимодействия с REST API бэкенда
- **Valkey (Redis)** — хранение сессий пользователей
- **APScheduler 4** — фоновые задачи (уведомления)
- **Pydantic Settings** — конфигурация через переменные окружения

## Архитектура

```
Telegram ←→ aiogram Bot ←→ TaskMate REST API (Laravel)
                ↕
            Valkey (сессии)
```

Бот не имеет прямого доступа к БД — всё взаимодействие через REST API бэкенда.

## Структура проекта

```
src/
├── main.py                 # Точка входа: запуск бота и планировщика
├── config.py               # Настройки (Pydantic Settings)
├── api/
│   └── client.py           # HTTP-клиент к TaskMate API
├── bot/
│   ├── bot.py              # Инициализация бота, AuthMiddleware
│   ├── messages.py         # Шаблоны сообщений (русский язык)
│   ├── keyboards.py        # Inline-клавиатуры
│   └── handlers/
│       ├── common.py       # /start, /help (публичные)
│       ├── auth.py         # /login, /logout
│       ├── tasks.py        # /tasks, /task, загрузка доказательств
│       └── shifts.py       # /shift, /shifts
├── scheduler/
│   └── polling.py          # Фоновые уведомления о задачах
└── storage/
    └── sessions.py         # Управление сессиями в Valkey
```

## Команды бота

| Команда | Доступ | Описание |
|---------|--------|----------|
| `/start` | Публичная | Приветствие и инструкция |
| `/help` | Публичная | Список доступных команд |
| `/login <логин> <пароль>` | Публичная | Авторизация (сообщение с паролем удаляется) |
| `/logout` | Авторизованная | Выход из системы |
| `/tasks` | Авторизованная | Список активных задач |
| `/task <ID>` | Авторизованная | Детали задачи с кнопками действий |
| `/shift` | Авторизованная | Текущая смена |
| `/shifts` | Авторизованная | Ближайшие 10 смен |

## Типы задач и действия

- **notification** — достаточно подтвердить прочтение (кнопка «Ознакомлен»)
- **completion** — отметить выполнение (кнопка «Выполнено»)
- **completion_with_proof** — загрузить фото/видео/документы как доказательство выполнения (FSM для сбора файлов)

## Фоновые уведомления

Планировщик периодически опрашивает API и отправляет уведомления всем авторизованным пользователям:

| Проверка | Интервал | Описание |
|----------|----------|----------|
| Новые задачи | 120 сек | Уведомление о назначенных задачах |
| Дедлайны | 300 сек | Предупреждение за 30 минут до дедлайна |
| Просроченные | 600 сек | Уведомление о просроченных задачах |

## Переменные окружения

| Переменная | По умолчанию | Описание |
|------------|-------------|----------|
| `TELEGRAM_BOT_TOKEN` | — (обязательная) | Токен Telegram Bot API |
| `TASKMATE_API_URL` | `http://api:8000/api/v1` | URL бэкенд API |
| `VALKEY_HOST` | `valkey` | Хост Valkey/Redis |
| `VALKEY_PORT` | `6379` | Порт Valkey |
| `VALKEY_DB` | `1` | Номер БД |
| `LOG_LEVEL` | `INFO` | Уровень логирования |
| `POLLING_INTERVAL_NEW_TASKS` | `120` | Интервал проверки новых задач (сек) |
| `POLLING_INTERVAL_DEADLINES` | `300` | Интервал проверки дедлайнов (сек) |
| `POLLING_INTERVAL_OVERDUE` | `600` | Интервал проверки просроченных (сек) |

## Запуск

### Через Docker (рекомендуется)

```bash
podman compose --profile bot up -d --build
```

Логи:

```bash
podman compose logs -f telegram-bot
```

### Локально (для разработки)

```bash
cp .env.example .env
# Заполнить .env

pip install -r requirements.txt
python -m src.main
```

## Безопасность

- Сообщение с паролем при `/login` удаляется сразу после обработки
- Токены хранятся в Valkey (in-memory, не персистятся на диск)
- Все запросы к API авторизованы через `Bearer` токен
- Бот не имеет прямого доступа к базе данных
